
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Clang-Tidy &#8212; Extra Clang Tools 7 documentation</title>
    <link rel="stylesheet" href="../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Clang-Tidy Checks" href="checks/list.html" />
    <link rel="prev" title="Extra Clang Tools 7.0.0 Release Notes" href="../ReleaseNotes.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../index.html">
          <span>Extra Clang Tools 7 documentation</span></a></h1>
        <h2 class="heading"><span>Clang-Tidy</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        «&#160;&#160;<a href="../ReleaseNotes.html">Extra Clang Tools 7.0.0 Release Notes</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="checks/list.html">Clang-Tidy Checks</a>&#160;&#160;»
        </p>

      </div>
      <div class="content" role="main">
        
        
  <div class="section" id="clang-tidy">
<h1><a class="toc-backref" href="#id2">Clang-Tidy</a><a class="headerlink" href="#clang-tidy" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#clang-tidy" id="id2">Clang-Tidy</a></p>
<ul>
<li><p><a class="reference internal" href="#using-clang-tidy" id="id3">Using clang-tidy</a></p></li>
<li><p><a class="reference internal" href="#getting-involved" id="id4">Getting Involved</a></p>
<ul>
<li><p><a class="reference internal" href="#choosing-the-right-place-for-your-check" id="id5">Choosing the Right Place for your Check</a></p></li>
<li><p><a class="reference internal" href="#preparing-your-workspace" id="id6">Preparing your Workspace</a></p></li>
<li><p><a class="reference internal" href="#the-directory-structure" id="id7">The Directory Structure</a></p></li>
<li><p><a class="reference internal" href="#writing-a-clang-tidy-check" id="id8">Writing a clang-tidy Check</a></p></li>
<li><p><a class="reference internal" href="#registering-your-check" id="id9">Registering your Check</a></p></li>
<li><p><a class="reference internal" href="#configuring-checks" id="id10">Configuring Checks</a></p></li>
<li><p><a class="reference internal" href="#testing-checks" id="id11">Testing Checks</a></p></li>
<li><p><a class="reference internal" href="#running-clang-tidy-on-llvm" id="id12">Running clang-tidy on LLVM</a></p></li>
<li><p><a class="reference internal" href="#on-checks-profiling" id="id13">On checks profiling</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<p>See also:</p>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="checks/list.html">The list of clang-tidy checks</a></li>
</ul>
</div>
<p><strong class="program">clang-tidy</strong> is a clang-based C++ “linter” tool. Its purpose is to
provide an extensible framework for diagnosing and fixing typical programming
errors, like style violations, interface misuse, or bugs that can be deduced via
static analysis. <strong class="program">clang-tidy</strong> is modular and provides a convenient
interface for writing new checks.</p>
<div class="section" id="using-clang-tidy">
<h2><a class="toc-backref" href="#id3">Using clang-tidy</a><a class="headerlink" href="#using-clang-tidy" title="Permalink to this headline">¶</a></h2>
<p><strong class="program">clang-tidy</strong> is a <a class="reference external" href="http://clang.llvm.org/docs/LibTooling.html">LibTooling</a>-based tool, and it’s easier to work
with if you set up a compile command database for your project (for an example
of how to do this see <a class="reference external" href="http://clang.llvm.org/docs/HowToSetupToolingForLLVM.html">How To Setup Tooling For LLVM</a>). You can also specify
compilation options on the command line after <code class="docutils literal notranslate"><span class="pre">--</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> clang-tidy test.cpp -- -Imy_project/include -DMY_DEFINES ...
</pre></div>
</div>
<p><strong class="program">clang-tidy</strong> has its own checks and can also run Clang static analyzer
checks. Each check has a name and the checks to run can be chosen using the
<code class="docutils literal notranslate"><span class="pre">-checks=</span></code> option, which specifies a comma-separated list of positive and
negative (prefixed with <code class="docutils literal notranslate"><span class="pre">-</span></code>) globs. Positive globs add subsets of checks,
negative globs remove them. For example,</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> clang-tidy test.cpp -checks<span class="o">=</span>-*,clang-analyzer-*,-clang-analyzer-cplusplus*
</pre></div>
</div>
<p>will disable all default checks (<code class="docutils literal notranslate"><span class="pre">-*</span></code>) and enable all <code class="docutils literal notranslate"><span class="pre">clang-analyzer-*</span></code>
checks except for <code class="docutils literal notranslate"><span class="pre">clang-analyzer-cplusplus*</span></code> ones.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">-list-checks</span></code> option lists all the enabled checks. When used without
<code class="docutils literal notranslate"><span class="pre">-checks=</span></code>, it shows checks enabled by default. Use <code class="docutils literal notranslate"><span class="pre">-checks=*</span></code> to see all
available checks or with any other value of <code class="docutils literal notranslate"><span class="pre">-checks=</span></code> to see which checks are
enabled by this value.</p>
<p id="checks-groups-table">There are currently the following groups of checks:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 28%" />
<col style="width: 72%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name prefix</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">android-</span></code></p></td>
<td><p>Checks related to Android.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">boost-</span></code></p></td>
<td><p>Checks related to Boost library.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">bugprone-</span></code></p></td>
<td><p>Checks that target bugprone code constructs.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">cert-</span></code></p></td>
<td><p>Checks related to CERT Secure Coding Guidelines.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">cppcoreguidelines-</span></code></p></td>
<td><p>Checks related to C++ Core Guidelines.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">clang-analyzer-</span></code></p></td>
<td><p>Clang Static Analyzer checks.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">fuchsia-</span></code></p></td>
<td><p>Checks related to Fuchsia coding conventions.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">google-</span></code></p></td>
<td><p>Checks related to Google coding conventions.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">hicpp-</span></code></p></td>
<td><p>Checks related to High Integrity C++ Coding Standard.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">llvm-</span></code></p></td>
<td><p>Checks related to the LLVM coding conventions.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">misc-</span></code></p></td>
<td><p>Checks that we didn’t have a better category for.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">modernize-</span></code></p></td>
<td><p>Checks that advocate usage of modern (currently “modern”
means “C++11”) language constructs.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">mpi-</span></code></p></td>
<td><p>Checks related to MPI (Message Passing Interface).</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">objc-</span></code></p></td>
<td><p>Checks related to Objective-C coding conventions.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">performance-</span></code></p></td>
<td><p>Checks that target performance-related issues.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">portability-</span></code></p></td>
<td><p>Checks that target portability-related issues that don’t
relate to any particular coding style.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">readability-</span></code></p></td>
<td><p>Checks that target readability-related issues that don’t
relate to any particular coding style.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">zircon-</span></code></p></td>
<td><p>Checks related to Zircon kernel coding conventions.</p></td>
</tr>
</tbody>
</table>
<p>Clang diagnostics are treated in a similar way as check diagnostics. Clang
diagnostics are displayed by <strong class="program">clang-tidy</strong> and can be filtered out using
<code class="docutils literal notranslate"><span class="pre">-checks=</span></code> option. However, the <code class="docutils literal notranslate"><span class="pre">-checks=</span></code> option does not affect
compilation arguments, so it can not turn on Clang warnings which are not
already turned on in build configuration. The <code class="docutils literal notranslate"><span class="pre">-warnings-as-errors=</span></code> option
upgrades any warnings emitted under the <code class="docutils literal notranslate"><span class="pre">-checks=</span></code> flag to errors (but it
does not enable any checks itself).</p>
<p>Clang diagnostics have check names starting with <code class="docutils literal notranslate"><span class="pre">clang-diagnostic-</span></code>.
Diagnostics which have a corresponding warning option, are named
<code class="docutils literal notranslate"><span class="pre">clang-diagnostic-&lt;warning-option&gt;</span></code>, e.g. Clang warning controlled by
<code class="docutils literal notranslate"><span class="pre">-Wliteral-conversion</span></code> will be reported with check name
<code class="docutils literal notranslate"><span class="pre">clang-diagnostic-literal-conversion</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">-fix</span></code> flag instructs <strong class="program">clang-tidy</strong> to fix found errors if
supported by corresponding checks.</p>
<p>An overview of all the command-line options:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> clang-tidy --help
<span class="go">USAGE: clang-tidy [options] &lt;source0&gt; [... &lt;sourceN&gt;]</span>

<span class="go">OPTIONS:</span>

<span class="go">Generic Options:</span>

<span class="go">  -help                         - Display available options (-help-hidden for more)</span>
<span class="go">  -help-list                    - Display list of available options (-help-list-hidden for more)</span>
<span class="go">  -version                      - Display the version of this program</span>

<span class="go">clang-tidy options:</span>

<span class="go">  -checks=&lt;string&gt;              -</span>
<span class="go">                                  Comma-separated list of globs with optional &#39;-&#39;</span>
<span class="go">                                  prefix. Globs are processed in order of</span>
<span class="go">                                  appearance in the list. Globs without &#39;-&#39;</span>
<span class="go">                                  prefix add checks with matching names to the</span>
<span class="go">                                  set, globs with the &#39;-&#39; prefix remove checks</span>
<span class="go">                                  with matching names from the set of enabled</span>
<span class="go">                                  checks. This option&#39;s value is appended to the</span>
<span class="go">                                  value of the &#39;Checks&#39; option in .clang-tidy</span>
<span class="go">                                  file, if any.</span>
<span class="go">  -config=&lt;string&gt;              -</span>
<span class="go">                                  Specifies a configuration in YAML/JSON format:</span>
<span class="go">                                    -config=&quot;{Checks: &#39;*&#39;,</span>
<span class="go">                                              CheckOptions: [{key: x,</span>
<span class="go">                                                              value: y}]}&quot;</span>
<span class="go">                                  When the value is empty, clang-tidy will</span>
<span class="go">                                  attempt to find a file named .clang-tidy for</span>
<span class="go">                                  each source file in its parent directories.</span>
<span class="go">  -dump-config                  -</span>
<span class="go">                                  Dumps configuration in the YAML format to</span>
<span class="go">                                  stdout. This option can be used along with a</span>
<span class="go">                                  file name (and &#39;--&#39; if the file is outside of a</span>
<span class="go">                                  project with configured compilation database).</span>
<span class="go">                                  The configuration used for this file will be</span>
<span class="go">                                  printed.</span>
<span class="go">                                  Use along with -checks=* to include</span>
<span class="go">                                  configuration of all checks.</span>
<span class="go">  -enable-check-profile         -</span>
<span class="go">                                  Enable per-check timing profiles, and print a</span>
<span class="go">                                  report to stderr.</span>
<span class="go">  -explain-config               -</span>
<span class="go">                                  For each enabled check explains, where it is</span>
<span class="go">                                  enabled, i.e. in clang-tidy binary, command</span>
<span class="go">                                  line or a specific configuration file.</span>
<span class="go">  -export-fixes=&lt;filename&gt;      -</span>
<span class="go">                                  YAML file to store suggested fixes in. The</span>
<span class="go">                                  stored fixes can be applied to the input source</span>
<span class="go">                                  code with clang-apply-replacements.</span>
<span class="go">  -extra-arg=&lt;string&gt;           - Additional argument to append to the compiler command line</span>
<span class="go">  -extra-arg-before=&lt;string&gt;    - Additional argument to prepend to the compiler command line</span>
<span class="go">  -fix                          -</span>
<span class="go">                                  Apply suggested fixes. Without -fix-errors</span>
<span class="go">                                  clang-tidy will bail out if any compilation</span>
<span class="go">                                  errors were found.</span>
<span class="go">  -fix-errors                   -</span>
<span class="go">                                  Apply suggested fixes even if compilation</span>
<span class="go">                                  errors were found. If compiler errors have</span>
<span class="go">                                  attached fix-its, clang-tidy will apply them as</span>
<span class="go">                                  well.</span>
<span class="go">  -format-style=&lt;string&gt;        -</span>
<span class="go">                                  Style for formatting code around applied fixes:</span>
<span class="go">                                    - &#39;none&#39; (default) turns off formatting</span>
<span class="go">                                    - &#39;file&#39; (literally &#39;file&#39;, not a placeholder)</span>
<span class="go">                                      uses .clang-format file in the closest parent</span>
<span class="go">                                      directory</span>
<span class="go">                                    - &#39;{ &lt;json&gt; }&#39; specifies options inline, e.g.</span>
<span class="go">                                      -format-style=&#39;{BasedOnStyle: llvm, IndentWidth: 8}&#39;</span>
<span class="go">                                    - &#39;llvm&#39;, &#39;google&#39;, &#39;webkit&#39;, &#39;mozilla&#39;</span>
<span class="go">                                  See clang-format documentation for the up-to-date</span>
<span class="go">                                  information about formatting styles and options.</span>
<span class="go">                                  This option overrides the &#39;FormatStyle` option in</span>
<span class="go">                                  .clang-tidy file, if any.</span>
<span class="go">  -header-filter=&lt;string&gt;       -</span>
<span class="go">                                  Regular expression matching the names of the</span>
<span class="go">                                  headers to output diagnostics from. Diagnostics</span>
<span class="go">                                  from the main file of each translation unit are</span>
<span class="go">                                  always displayed.</span>
<span class="go">                                  Can be used together with -line-filter.</span>
<span class="go">                                  This option overrides the &#39;HeaderFilter&#39; option</span>
<span class="go">                                  in .clang-tidy file, if any.</span>
<span class="go">  -line-filter=&lt;string&gt;         -</span>
<span class="go">                                  List of files with line ranges to filter the</span>
<span class="go">                                  warnings. Can be used together with</span>
<span class="go">                                  -header-filter. The format of the list is a</span>
<span class="go">                                  JSON array of objects:</span>
<span class="go">                                    [</span>
<span class="go">                                      {&quot;name&quot;:&quot;file1.cpp&quot;,&quot;lines&quot;:[[1,3],[5,7]]},</span>
<span class="go">                                      {&quot;name&quot;:&quot;file2.h&quot;}</span>
<span class="go">                                    ]</span>
<span class="go">  -list-checks                  -</span>
<span class="go">                                  List all enabled checks and exit. Use with</span>
<span class="go">                                  -checks=* to list all available checks.</span>
<span class="go">  -p=&lt;string&gt;                   - Build path</span>
<span class="go">  -quiet                        -</span>
<span class="go">                                  Run clang-tidy in quiet mode. This suppresses</span>
<span class="go">                                  printing statistics about ignored warnings and</span>
<span class="go">                                  warnings treated as errors if the respective</span>
<span class="go">                                  options are specified.</span>
<span class="go">  -store-check-profile=&lt;prefix&gt; -</span>
<span class="go">                                  By default reports are printed in tabulated</span>
<span class="go">                                  format to stderr. When this option is passed,</span>
<span class="go">                                  these per-TU profiles are instead stored as JSON.</span>
<span class="go">  -system-headers               - Display the errors from system headers.</span>
<span class="go">  -vfsoverlay=&lt;filename&gt;        -</span>
<span class="go">                                  Overlay the virtual filesystem described by file</span>
<span class="go">                                  over the real file system.</span>
<span class="go">  -warnings-as-errors=&lt;string&gt;  -</span>
<span class="go">                                  Upgrades warnings to errors. Same format as</span>
<span class="go">                                  &#39;-checks&#39;.</span>
<span class="go">                                  This option&#39;s value is appended to the value of</span>
<span class="go">                                  the &#39;WarningsAsErrors&#39; option in .clang-tidy</span>
<span class="go">                                  file, if any.</span>

<span class="go">-p &lt;build-path&gt; is used to read a compile command database.</span>

<span class="go">        For example, it can be a CMake build directory in which a file named</span>
<span class="go">        compile_commands.json exists (use -DCMAKE_EXPORT_COMPILE_COMMANDS=ON</span>
<span class="go">        CMake option to get this output). When no build path is specified,</span>
<span class="go">        a search for compile_commands.json will be attempted through all</span>
<span class="go">        parent paths of the first input file . See:</span>
<span class="go">        http://clang.llvm.org/docs/HowToSetupToolingForLLVM.html for an</span>
<span class="go">        example of setting up Clang Tooling on a source tree.</span>

<span class="go">&lt;source0&gt; ... specify the paths of source files. These paths are</span>
<span class="go">        looked up in the compile command database. If the path of a file is</span>
<span class="go">        absolute, it needs to point into CMake&#39;s source tree. If the path is</span>
<span class="go">        relative, the current working directory needs to be in the CMake</span>
<span class="go">        source tree and the file must be in a subdirectory of the current</span>
<span class="go">        working directory. &quot;./&quot; prefixes in the relative files will be</span>
<span class="go">        automatically removed, but the rest of a relative path must be a</span>
<span class="go">        suffix of a path in the compile command database.</span>


<span class="go">Configuration files:</span>
<span class="go">  clang-tidy attempts to read configuration for each source file from a</span>
<span class="go">  .clang-tidy file located in the closest parent directory of the source</span>
<span class="go">  file. If any configuration options have a corresponding command-line</span>
<span class="go">  option, command-line option takes precedence. The effective</span>
<span class="go">  configuration can be inspected using -dump-config:</span>

<span class="gp">    $</span> clang-tidy -dump-config
<span class="go">    ---</span>
<span class="go">    Checks:          &#39;-*,some-check&#39;</span>
<span class="go">    WarningsAsErrors: &#39;&#39;</span>
<span class="go">    HeaderFilterRegex: &#39;&#39;</span>
<span class="go">    FormatStyle:     none</span>
<span class="go">    User:            user</span>
<span class="go">    CheckOptions:</span>
<span class="go">      - key:             some-check.SomeOption</span>
<span class="go">        value:           &#39;some value&#39;</span>
<span class="go">    ...</span>
</pre></div>
</div>
<p><strong class="program">clang-tidy</strong> diagnostics are intended to call out code that does
not adhere to a coding standard, or is otherwise problematic in some way.
However, if it is known that the code is correct, the check-specific ways
to silence the diagnostics could be used, if they are available (e.g.
bugprone-use-after-move can be silenced by re-initializing the variable after
it has been moved out, misc-string-integer-assignment can be suppressed by
explicitly casting the integer to char, readability-implicit-bool-conversion
can also be suppressed by using explicit casts, etc.). If they are not
available or if changing the semantics of the code is not desired,
the <code class="docutils literal notranslate"><span class="pre">NOLINT</span></code> or <code class="docutils literal notranslate"><span class="pre">NOLINTNEXTLINE</span></code> comments can be used instead. For example:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span>
<span class="p">{</span>
  <span class="c1">// Silent all the diagnostics for the line</span>
  <span class="n">Foo</span><span class="p">(</span><span class="kt">int</span> <span class="n">param</span><span class="p">);</span> <span class="c1">// NOLINT</span>

  <span class="c1">// Silent only the specified checks for the line</span>
  <span class="n">Foo</span><span class="p">(</span><span class="kt">double</span> <span class="n">param</span><span class="p">);</span> <span class="c1">// NOLINT(google-explicit-constructor, google-runtime-int)</span>

  <span class="c1">// Silent only the specified diagnostics for the next line</span>
  <span class="c1">// NOLINTNEXTLINE(google-explicit-constructor, google-runtime-int)</span>
  <span class="n">Foo</span><span class="p">(</span><span class="kt">bool</span> <span class="n">param</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The formal syntax of <code class="docutils literal notranslate"><span class="pre">NOLINT</span></code>/<code class="docutils literal notranslate"><span class="pre">NOLINTNEXTLINE</span></code> is the following:</p>
<pre class="literal-block">lint-comment:
  lint-command
  lint-command lint-args

lint-args:
  <strong>(</strong> check-name-list <strong>)</strong>

check-name-list:
  <em>check-name</em>
  check-name-list <strong>,</strong> <em>check-name</em>

lint-command:
  <strong>NOLINT</strong>
  <strong>NOLINTNEXTLINE</strong></pre>
<p>Note that whitespaces between <code class="docutils literal notranslate"><span class="pre">NOLINT</span></code>/<code class="docutils literal notranslate"><span class="pre">NOLINTNEXTLINE</span></code> and the opening
parenthesis are not allowed (in this case the comment will be treated just as
<code class="docutils literal notranslate"><span class="pre">NOLINT</span></code>/<code class="docutils literal notranslate"><span class="pre">NOLINTNEXTLINE</span></code>), whereas in check names list (inside
the parenthesis) whitespaces can be used and will be ignored.</p>
</div>
<div class="section" id="getting-involved">
<h2><a class="toc-backref" href="#id4">Getting Involved</a><a class="headerlink" href="#getting-involved" title="Permalink to this headline">¶</a></h2>
<p><strong class="program">clang-tidy</strong> has several own checks and can run Clang static analyzer
checks, but its power is in the ability to easily write custom checks.</p>
<p>Checks are organized in modules, which can be linked into <strong class="program">clang-tidy</strong>
with minimal or no code changes in <strong class="program">clang-tidy</strong>.</p>
<p>Checks can plug into the analysis on the preprocessor level using <a class="reference external" href="http://clang.llvm.org/doxygen/classclang_1_1PPCallbacks.html">PPCallbacks</a>
or on the AST level using <a class="reference external" href="http://clang.llvm.org/docs/LibASTMatchers.html">AST Matchers</a>. When an error is found, checks can
report them in a way similar to how Clang diagnostics work. A fix-it hint can be
attached to a diagnostic message.</p>
<p>The interface provided by <strong class="program">clang-tidy</strong> makes it easy to write useful
and precise checks in just a few lines of code. If you have an idea for a good
check, the rest of this document explains how to do this.</p>
<dl class="simple">
<dt>There are a few tools particularly useful when developing clang-tidy checks:</dt><dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">add_new_check.py</span></code> is a script to automate the process of adding a new
check, it will create the check, update the CMake file and create a test;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rename_check.py</span></code> does what the script name suggests, renames an existing
check;</p></li>
<li><p><strong class="program">clang-query</strong> is invaluable for interactive prototyping of AST
matchers and exploration of the Clang AST;</p></li>
<li><p><a class="reference external" href="http://clang.llvm.org/docs/ClangCheck.html">clang-check</a> with the <code class="docutils literal notranslate"><span class="pre">-ast-dump</span></code> (and optionally <code class="docutils literal notranslate"><span class="pre">-ast-dump-filter</span></code>)
provides a convenient way to dump AST of a C++ program.</p></li>
</ul>
</dd>
</dl>
<div class="section" id="choosing-the-right-place-for-your-check">
<h3><a class="toc-backref" href="#id5">Choosing the Right Place for your Check</a><a class="headerlink" href="#choosing-the-right-place-for-your-check" title="Permalink to this headline">¶</a></h3>
<p>If you have an idea of a check, you should decide whether it should be
implemented as a:</p>
<ul class="simple">
<li><p><em>Clang diagnostic</em>: if the check is generic enough, targets code patterns that
most probably are bugs (rather than style or readability issues), can be
implemented effectively and with extremely low false positive rate, it may
make a good Clang diagnostic.</p></li>
<li><p><em>Clang static analyzer check</em>: if the check requires some sort of control flow
analysis, it should probably be implemented as a static analyzer check.</p></li>
<li><p><em>clang-tidy check</em> is a good choice for linter-style checks, checks that are
related to a certain coding style, checks that address code readability, etc.</p></li>
</ul>
</div>
<div class="section" id="preparing-your-workspace">
<h3><a class="toc-backref" href="#id6">Preparing your Workspace</a><a class="headerlink" href="#preparing-your-workspace" title="Permalink to this headline">¶</a></h3>
<p>If you are new to LLVM development, you should read the <a class="reference external" href="http://llvm.org/docs/GettingStarted.html">Getting Started with
the LLVM System</a>, <a class="reference external" href="http://clang.llvm.org/docs/ClangTools.html">Using Clang Tools</a> and <a class="reference external" href="http://clang.llvm.org/docs/HowToSetupToolingForLLVM.html">How To Setup Tooling For LLVM</a>
documents to check out and build LLVM, Clang and Clang Extra Tools with CMake.</p>
<p>Once you are done, change to the <code class="docutils literal notranslate"><span class="pre">llvm/tools/clang/tools/extra</span></code> directory, and
let’s start!</p>
</div>
<div class="section" id="the-directory-structure">
<h3><a class="toc-backref" href="#id7">The Directory Structure</a><a class="headerlink" href="#the-directory-structure" title="Permalink to this headline">¶</a></h3>
<p><strong class="program">clang-tidy</strong> source code resides in the
<code class="docutils literal notranslate"><span class="pre">llvm/tools/clang/tools/extra</span></code> directory and is structured as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">clang</span><span class="o">-</span><span class="n">tidy</span><span class="o">/</span>                       <span class="c1"># Clang-tidy core.</span>
<span class="o">|--</span> <span class="n">ClangTidy</span><span class="o">.</span><span class="n">h</span>                   <span class="c1"># Interfaces for users and checks.</span>
<span class="o">|--</span> <span class="n">ClangTidyModule</span><span class="o">.</span><span class="n">h</span>             <span class="c1"># Interface for clang-tidy modules.</span>
<span class="o">|--</span> <span class="n">ClangTidyModuleRegistry</span><span class="o">.</span><span class="n">h</span>     <span class="c1"># Interface for registering of modules.</span>
   <span class="o">...</span>
<span class="o">|--</span> <span class="n">google</span><span class="o">/</span>                       <span class="c1"># Google clang-tidy module.</span>
<span class="o">|-+</span>
  <span class="o">|--</span> <span class="n">GoogleTidyModule</span><span class="o">.</span><span class="n">cpp</span>
  <span class="o">|--</span> <span class="n">GoogleTidyModule</span><span class="o">.</span><span class="n">h</span>
        <span class="o">...</span>
<span class="o">|--</span> <span class="n">llvm</span><span class="o">/</span>                         <span class="c1"># LLVM clang-tidy module.</span>
<span class="o">|-+</span>
  <span class="o">|--</span> <span class="n">LLVMTidyModule</span><span class="o">.</span><span class="n">cpp</span>
  <span class="o">|--</span> <span class="n">LLVMTidyModule</span><span class="o">.</span><span class="n">h</span>
        <span class="o">...</span>
<span class="o">|--</span> <span class="n">objc</span><span class="o">/</span>                         <span class="c1"># Objective-C clang-tidy module.</span>
<span class="o">|-+</span>
  <span class="o">|--</span> <span class="n">ObjCTidyModule</span><span class="o">.</span><span class="n">cpp</span>
  <span class="o">|--</span> <span class="n">ObjCTidyModule</span><span class="o">.</span><span class="n">h</span>
        <span class="o">...</span>
<span class="o">|--</span> <span class="n">tool</span><span class="o">/</span>                         <span class="c1"># Sources of the clang-tidy binary.</span>
        <span class="o">...</span>
<span class="n">test</span><span class="o">/</span><span class="n">clang</span><span class="o">-</span><span class="n">tidy</span><span class="o">/</span>                  <span class="c1"># Integration tests.</span>
    <span class="o">...</span>
<span class="n">unittests</span><span class="o">/</span><span class="n">clang</span><span class="o">-</span><span class="n">tidy</span><span class="o">/</span>             <span class="c1"># Unit tests.</span>
<span class="o">|--</span> <span class="n">ClangTidyTest</span><span class="o">.</span><span class="n">h</span>
<span class="o">|--</span> <span class="n">GoogleModuleTest</span><span class="o">.</span><span class="n">cpp</span>
<span class="o">|--</span> <span class="n">LLVMModuleTest</span><span class="o">.</span><span class="n">cpp</span>
<span class="o">|--</span> <span class="n">ObjCModuleTest</span><span class="o">.</span><span class="n">cpp</span>
    <span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="writing-a-clang-tidy-check">
<h3><a class="toc-backref" href="#id8">Writing a clang-tidy Check</a><a class="headerlink" href="#writing-a-clang-tidy-check" title="Permalink to this headline">¶</a></h3>
<p>So you have an idea of a useful check for <strong class="program">clang-tidy</strong>.</p>
<p>First, if you’re not familiar with LLVM development, read through the <a class="reference external" href="http://llvm.org/docs/GettingStarted.html">Getting
Started with LLVM</a> document for instructions on setting up your workflow and
the <a class="reference external" href="http://llvm.org/docs/CodingStandards.html">LLVM Coding Standards</a> document to familiarize yourself with the coding
style used in the project. For code reviews we mostly use <a class="reference external" href="http://llvm.org/docs/Phabricator.html">LLVM Phabricator</a>.</p>
<p>Next, you need to decide which module the check belongs to. Modules
are located in subdirectories of <a class="reference external" href="http://reviews.llvm.org/diffusion/L/browse/clang-tools-extra/trunk/clang-tidy/">clang-tidy/</a>
and contain checks targeting a certain aspect of code quality (performance,
readability, etc.), certain coding style or standard (Google, LLVM, CERT, etc.)
or a widely used API (e.g. MPI). Their names are same as user-facing check
groups names described <a class="reference internal" href="#checks-groups-table"><span class="std std-ref">above</span></a>.</p>
<p>After choosing the module and the name for the check, run the
<code class="docutils literal notranslate"><span class="pre">clang-tidy/add_new_check.py</span></code> script to create the skeleton of the check and
plug it to <strong class="program">clang-tidy</strong>. It’s the recommended way of adding new checks.</p>
<p>If we want to create a <cite>readability-awesome-function-names</cite>, we would run:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> clang-tidy/add_new_check.py readability awesome-function-names
</pre></div>
</div>
<dl class="simple">
<dt>The <code class="docutils literal notranslate"><span class="pre">add_new_check.py</span></code> script will:</dt><dd><ul class="simple">
<li><p>create the class for your check inside the specified module’s directory and
register it in the module and in the build system;</p></li>
<li><p>create a lit test file in the <code class="docutils literal notranslate"><span class="pre">test/clang-tidy/</span></code> directory;</p></li>
<li><p>create a documentation file and include it into the
<code class="docutils literal notranslate"><span class="pre">docs/clang-tidy/checks/list.rst</span></code>.</p></li>
</ul>
</dd>
</dl>
<p>Let’s see in more detail at the check class definition:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="p">...</span>

<span class="cp">#include</span> <span class="cpf">&quot;../ClangTidy.h&quot;</span><span class="cp"></span>

<span class="k">namespace</span> <span class="n">clang</span> <span class="p">{</span>
<span class="k">namespace</span> <span class="n">tidy</span> <span class="p">{</span>
<span class="k">namespace</span> <span class="n">readability</span> <span class="p">{</span>

<span class="p">...</span>
<span class="k">class</span> <span class="nc">AwesomeFunctionNamesCheck</span> <span class="o">:</span> <span class="k">public</span> <span class="n">ClangTidyCheck</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">AwesomeFunctionNamesCheck</span><span class="p">(</span><span class="n">StringRef</span> <span class="n">Name</span><span class="p">,</span> <span class="n">ClangTidyContext</span> <span class="o">*</span><span class="n">Context</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">ClangTidyCheck</span><span class="p">(</span><span class="n">Name</span><span class="p">,</span> <span class="n">Context</span><span class="p">)</span> <span class="p">{}</span>
  <span class="kt">void</span> <span class="n">registerMatchers</span><span class="p">(</span><span class="n">ast_matchers</span><span class="o">::</span><span class="n">MatchFinder</span> <span class="o">*</span><span class="n">Finder</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>
  <span class="kt">void</span> <span class="nf">check</span><span class="p">(</span><span class="k">const</span> <span class="n">ast_matchers</span><span class="o">::</span><span class="n">MatchFinder</span><span class="o">::</span><span class="n">MatchResult</span> <span class="o">&amp;</span><span class="n">Result</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>
<span class="p">};</span>

<span class="p">}</span> <span class="c1">// namespace readability</span>
<span class="p">}</span> <span class="c1">// namespace tidy</span>
<span class="p">}</span> <span class="c1">// namespace clang</span>

<span class="p">...</span>
</pre></div>
</div>
<p>Constructor of the check receives the <code class="docutils literal notranslate"><span class="pre">Name</span></code> and <code class="docutils literal notranslate"><span class="pre">Context</span></code> parameters, and
must forward them to the <code class="docutils literal notranslate"><span class="pre">ClangTidyCheck</span></code> constructor.</p>
<p>In our case the check needs to operate on the AST level and it overrides the
<code class="docutils literal notranslate"><span class="pre">registerMatchers</span></code> and <code class="docutils literal notranslate"><span class="pre">check</span></code> methods. If we wanted to analyze code on the
preprocessor level, we’d need instead to override the <code class="docutils literal notranslate"><span class="pre">registerPPCallbacks</span></code>
method.</p>
<p>In the <code class="docutils literal notranslate"><span class="pre">registerMatchers</span></code> method we create an AST Matcher (see <a class="reference external" href="http://clang.llvm.org/docs/LibASTMatchers.html">AST Matchers</a>
for more information) that will find the pattern in the AST that we want to
inspect. The results of the matching are passed to the <code class="docutils literal notranslate"><span class="pre">check</span></code> method, which
can further inspect them and report diagnostics.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">using</span> <span class="k">namespace</span> <span class="n">ast_matchers</span><span class="p">;</span>

<span class="kt">void</span> <span class="n">AwesomeFunctionNamesCheck</span><span class="o">::</span><span class="n">registerMatchers</span><span class="p">(</span><span class="n">MatchFinder</span> <span class="o">*</span><span class="n">Finder</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Finder</span><span class="o">-&gt;</span><span class="n">addMatcher</span><span class="p">(</span><span class="n">functionDecl</span><span class="p">().</span><span class="n">bind</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">),</span> <span class="k">this</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">AwesomeFunctionNamesCheck</span><span class="o">::</span><span class="n">check</span><span class="p">(</span><span class="k">const</span> <span class="n">MatchFinder</span><span class="o">::</span><span class="n">MatchResult</span> <span class="o">&amp;</span><span class="n">Result</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">const</span> <span class="k">auto</span> <span class="o">*</span><span class="n">MatchedDecl</span> <span class="o">=</span> <span class="n">Result</span><span class="p">.</span><span class="n">Nodes</span><span class="p">.</span><span class="n">getNodeAs</span><span class="o">&lt;</span><span class="n">FunctionDecl</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">MatchedDecl</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">().</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;awesome_&quot;</span><span class="p">))</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="n">diag</span><span class="p">(</span><span class="n">MatchedDecl</span><span class="o">-&gt;</span><span class="n">getLocation</span><span class="p">(),</span> <span class="s">&quot;function %0 is insufficiently awesome&quot;</span><span class="p">)</span>
      <span class="o">&lt;&lt;</span> <span class="n">MatchedDecl</span>
      <span class="o">&lt;&lt;</span> <span class="n">FixItHint</span><span class="o">::</span><span class="n">CreateInsertion</span><span class="p">(</span><span class="n">MatchedDecl</span><span class="o">-&gt;</span><span class="n">getLocation</span><span class="p">(),</span> <span class="s">&quot;awesome_&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>(If you want to see an example of a useful check, look at
<a class="reference external" href="http://reviews.llvm.org/diffusion/L/browse/clang-tools-extra/trunk/clang-tidy/google/ExplicitConstructorCheck.h">clang-tidy/google/ExplicitConstructorCheck.h</a>
and <a class="reference external" href="http://reviews.llvm.org/diffusion/L/browse/clang-tools-extra/trunk/clang-tidy/google/ExplicitConstructorCheck.cpp">clang-tidy/google/ExplicitConstructorCheck.cpp</a>).</p>
</div>
<div class="section" id="registering-your-check">
<h3><a class="toc-backref" href="#id9">Registering your Check</a><a class="headerlink" href="#registering-your-check" title="Permalink to this headline">¶</a></h3>
<p>(The <code class="docutils literal notranslate"><span class="pre">add_new_check.py</span></code> takes care of registering the check in an existing
module. If you want to create a new module or know the details, read on.)</p>
<p>The check should be registered in the corresponding module with a distinct name:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyModule</span> <span class="o">:</span> <span class="k">public</span> <span class="n">ClangTidyModule</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">addCheckFactories</span><span class="p">(</span><span class="n">ClangTidyCheckFactories</span> <span class="o">&amp;</span><span class="n">CheckFactories</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
    <span class="n">CheckFactories</span><span class="p">.</span><span class="n">registerCheck</span><span class="o">&lt;</span><span class="n">ExplicitConstructorCheck</span><span class="o">&gt;</span><span class="p">(</span>
        <span class="s">&quot;my-explicit-constructor&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Now we need to register the module in the <code class="docutils literal notranslate"><span class="pre">ClangTidyModuleRegistry</span></code> using a
statically initialized variable:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="n">ClangTidyModuleRegistry</span><span class="o">::</span><span class="n">Add</span><span class="o">&lt;</span><span class="n">MyModule</span><span class="o">&gt;</span> <span class="n">X</span><span class="p">(</span><span class="s">&quot;my-module&quot;</span><span class="p">,</span>
                                                <span class="s">&quot;Adds my lint checks.&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>When using LLVM build system, we need to use the following hack to ensure the
module is linked into the <strong class="program">clang-tidy</strong> binary:</p>
<p>Add this near the <code class="docutils literal notranslate"><span class="pre">ClangTidyModuleRegistry::Add&lt;MyModule&gt;</span></code> variable:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// This anchor is used to force the linker to link in the generated object file</span>
<span class="c1">// and thus register the MyModule.</span>
<span class="k">volatile</span> <span class="kt">int</span> <span class="n">MyModuleAnchorSource</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<p>And this to the main translation unit of the <strong class="program">clang-tidy</strong> binary (or
the binary you link the <code class="docutils literal notranslate"><span class="pre">clang-tidy</span></code> library in)
<code class="docutils literal notranslate"><span class="pre">clang-tidy/tool/ClangTidyMain.cpp</span></code>:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// This anchor is used to force the linker to link the MyModule.</span>
<span class="k">extern</span> <span class="k">volatile</span> <span class="kt">int</span> <span class="n">MyModuleAnchorSource</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">MyModuleAnchorDestination</span> <span class="o">=</span> <span class="n">MyModuleAnchorSource</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="configuring-checks">
<h3><a class="toc-backref" href="#id10">Configuring Checks</a><a class="headerlink" href="#configuring-checks" title="Permalink to this headline">¶</a></h3>
<p>If a check needs configuration options, it can access check-specific options
using the <code class="docutils literal notranslate"><span class="pre">Options.get&lt;Type&gt;(&quot;SomeOption&quot;,</span> <span class="pre">DefaultValue)</span></code> call in the check
constructor. In this case the check should also override the
<code class="docutils literal notranslate"><span class="pre">ClangTidyCheck::storeOptions</span></code> method to make the options provided by the
check discoverable. This method lets <strong class="program">clang-tidy</strong> know which options
the check implements and what the current values are (e.g. for the
<code class="docutils literal notranslate"><span class="pre">-dump-config</span></code> command line option).</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyCheck</span> <span class="o">:</span> <span class="k">public</span> <span class="n">ClangTidyCheck</span> <span class="p">{</span>
  <span class="k">const</span> <span class="kt">unsigned</span> <span class="n">SomeOption1</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">SomeOption2</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
  <span class="n">MyCheck</span><span class="p">(</span><span class="n">StringRef</span> <span class="n">Name</span><span class="p">,</span> <span class="n">ClangTidyContext</span> <span class="o">*</span><span class="n">Context</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">ClangTidyCheck</span><span class="p">(</span><span class="n">Name</span><span class="p">,</span> <span class="n">Context</span><span class="p">),</span>
      <span class="n">SomeOption</span><span class="p">(</span><span class="n">Options</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;SomeOption1&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1U</span><span class="p">)),</span>
      <span class="n">SomeOption</span><span class="p">(</span><span class="n">Options</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;SomeOption2&quot;</span><span class="p">,</span> <span class="s">&quot;some default&quot;</span><span class="p">))</span> <span class="p">{}</span>

  <span class="kt">void</span> <span class="n">storeOptions</span><span class="p">(</span><span class="n">ClangTidyOptions</span><span class="o">::</span><span class="n">OptionMap</span> <span class="o">&amp;</span><span class="n">Opts</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
    <span class="n">Options</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="n">Opts</span><span class="p">,</span> <span class="s">&quot;SomeOption1&quot;</span><span class="p">,</span> <span class="n">SomeOption1</span><span class="p">);</span>
    <span class="n">Options</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="n">Opts</span><span class="p">,</span> <span class="s">&quot;SomeOption2&quot;</span><span class="p">,</span> <span class="n">SomeOption2</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="p">...</span>
</pre></div>
</div>
<p>Assuming the check is registered with the name “my-check”, the option can then
be set in a <code class="docutils literal notranslate"><span class="pre">.clang-tidy</span></code> file in the following way:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">CheckOptions</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my-check.SomeOption1</span>
    <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">123</span>
  <span class="p p-Indicator">-</span> <span class="nt">key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my-check.SomeOption2</span>
    <span class="nt">value</span><span class="p">:</span> <span class="s">&#39;some</span><span class="nv"> </span><span class="s">other</span><span class="nv"> </span><span class="s">value&#39;</span>
</pre></div>
</div>
<p>If you need to specify check options on a command line, you can use the inline
YAML format:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> clang-tidy -config<span class="o">=</span><span class="s2">&quot;{CheckOptions: [{key: a, value: b}, {key: x, value: y}]}&quot;</span> ...
</pre></div>
</div>
</div>
<div class="section" id="testing-checks">
<h3><a class="toc-backref" href="#id11">Testing Checks</a><a class="headerlink" href="#testing-checks" title="Permalink to this headline">¶</a></h3>
<p>To run tests for <strong class="program">clang-tidy</strong> use the command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ninja check-clang-tools
</pre></div>
</div>
<p><strong class="program">clang-tidy</strong> checks can be tested using either unit tests or
<a class="reference external" href="http://llvm.org/docs/CommandGuide/lit.html">lit</a> tests. Unit tests may be more convenient to test complex replacements
with strict checks. <a class="reference external" href="http://llvm.org/docs/CommandGuide/lit.html">Lit</a> tests allow using partial text matching and regular
expressions which makes them more suitable for writing compact tests for
diagnostic messages.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">check_clang_tidy.py</span></code> script provides an easy way to test both
diagnostic messages and fix-its. It filters out <code class="docutils literal notranslate"><span class="pre">CHECK</span></code> lines from the test
file, runs <strong class="program">clang-tidy</strong> and verifies messages and fixes with two
separate <a class="reference external" href="http://llvm.org/docs/CommandGuide/FileCheck.html">FileCheck</a> invocations: once with FileCheck’s directive
prefix set to <code class="docutils literal notranslate"><span class="pre">CHECK-MESSAGES</span></code>, validating the diagnostic messages,
and once with the directive prefix set to <code class="docutils literal notranslate"><span class="pre">CHECK-FIXES</span></code>, running
against the fixed code (i.e., the code after generated fix-its are
applied). In particular, <code class="docutils literal notranslate"><span class="pre">CHECK-FIXES:</span></code> can be used to check
that code was not modified by fix-its, by checking that it is present
unchanged in the fixed code. The full set of <a class="reference external" href="http://llvm.org/docs/CommandGuide/FileCheck.html">FileCheck</a> directives
is available (e.g., <code class="docutils literal notranslate"><span class="pre">CHECK-MESSAGES-SAME:</span></code>, <code class="docutils literal notranslate"><span class="pre">CHECK-MESSAGES-NOT:</span></code>), though
typically the basic <code class="docutils literal notranslate"><span class="pre">CHECK</span></code> forms (<code class="docutils literal notranslate"><span class="pre">CHECK-MESSAGES</span></code> and <code class="docutils literal notranslate"><span class="pre">CHECK-FIXES</span></code>)
are sufficient for clang-tidy tests. Note that the <a class="reference external" href="http://llvm.org/docs/CommandGuide/FileCheck.html">FileCheck</a>
documentation mostly assumes the default prefix (<code class="docutils literal notranslate"><span class="pre">CHECK</span></code>), and hence
describes the directive as <code class="docutils literal notranslate"><span class="pre">CHECK:</span></code>, <code class="docutils literal notranslate"><span class="pre">CHECK-SAME:</span></code>, <code class="docutils literal notranslate"><span class="pre">CHECK-NOT:</span></code>, etc.
Replace <code class="docutils literal notranslate"><span class="pre">CHECK</span></code> by either <code class="docutils literal notranslate"><span class="pre">CHECK-FIXES</span></code> or <code class="docutils literal notranslate"><span class="pre">CHECK-MESSAGES</span></code> for
clang-tidy tests.</p>
<p>An additional check enabled by <code class="docutils literal notranslate"><span class="pre">check_clang_tidy.py</span></code> ensures that
if <cite>CHECK-MESSAGES:</cite> is used in a file then every warning or error
must have an associated CHECK in that file.</p>
<p>To use the <code class="docutils literal notranslate"><span class="pre">check_clang_tidy.py</span></code> script, put a .cpp file with the
appropriate <code class="docutils literal notranslate"><span class="pre">RUN</span></code> line in the <code class="docutils literal notranslate"><span class="pre">test/clang-tidy</span></code> directory. Use
<code class="docutils literal notranslate"><span class="pre">CHECK-MESSAGES:</span></code> and <code class="docutils literal notranslate"><span class="pre">CHECK-FIXES:</span></code> lines to write checks against
diagnostic messages and fixed code.</p>
<p>It’s advised to make the checks as specific as possible to avoid checks matching
to incorrect parts of the input. Use <code class="docutils literal notranslate"><span class="pre">[[&#64;LINE+X]]</span></code>/<code class="docutils literal notranslate"><span class="pre">[[&#64;LINE-X]]</span></code>
substitutions and distinct function and variable names in the test code.</p>
<p>Here’s an example of a test using the <code class="docutils literal notranslate"><span class="pre">check_clang_tidy.py</span></code> script (the full
source code is at <a class="reference external" href="http://reviews.llvm.org/diffusion/L/browse/clang-tools-extra/trunk/test/clang-tidy/google-readability-casting.cpp">test/clang-tidy/google-readability-casting.cpp</a>):</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// RUN: %check_clang_tidy %s google-readability-casting %t</span>

<span class="kt">void</span> <span class="nf">f</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">a</span><span class="p">;</span>
  <span class="c1">// CHECK-MESSAGES: :[[@LINE-1]]:11: warning: redundant cast to the same type [google-readability-casting]</span>
  <span class="c1">// CHECK-FIXES: int b = a;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To check more than one scenario in the same test file use
<code class="docutils literal notranslate"><span class="pre">-check-suffix=SUFFIX-NAME</span></code> on <code class="docutils literal notranslate"><span class="pre">check_clang_tidy.py</span></code> command line.
With <code class="docutils literal notranslate"><span class="pre">-check-suffix=SUFFIX-NAME</span></code> you need to replace your <code class="docutils literal notranslate"><span class="pre">CHECK-*</span></code>
directives with <code class="docutils literal notranslate"><span class="pre">CHECK-MESSAGES-SUFFIX-NAME</span></code> and <code class="docutils literal notranslate"><span class="pre">CHECK-FIXES-SUFFIX-NAME</span></code>.</p>
<p>Here’s an example:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// RUN: %check_clang_tidy -check-suffix=USING-A %s misc-unused-using-decls %t -- -- -DUSING_A</span>
<span class="c1">// RUN: %check_clang_tidy -check-suffix=USING-B %s misc-unused-using-decls %t -- -- -DUSING_B</span>
<span class="c1">// RUN: %check_clang_tidy %s misc-unused-using-decls %t</span>
<span class="p">...</span>
<span class="c1">// CHECK-MESSAGES-USING-A: :[[@LINE-8]]:10: warning: using decl &#39;A&#39; {{.*}}</span>
<span class="c1">// CHECK-MESSAGES-USING-B: :[[@LINE-7]]:10: warning: using decl &#39;B&#39; {{.*}}</span>
<span class="c1">// CHECK-MESSAGES: :[[@LINE-6]]:10: warning: using decl &#39;C&#39; {{.*}}</span>
<span class="c1">// CHECK-FIXES-USING-A-NOT: using a::A;$</span>
<span class="c1">// CHECK-FIXES-USING-B-NOT: using a::B;$</span>
<span class="c1">// CHECK-FIXES-NOT: using a::C;$</span>
</pre></div>
</div>
<p>There are many dark corners in the C++ language, and it may be difficult to make
your check work perfectly in all cases, especially if it issues fix-it hints. The
most frequent pitfalls are macros and templates:</p>
<ol class="arabic simple">
<li><p>code written in a macro body/template definition may have a different meaning
depending on the macro expansion/template instantiation;</p></li>
<li><p>multiple macro expansions/template instantiations may result in the same code
being inspected by the check multiple times (possibly, with different
meanings, see 1), and the same warning (or a slightly different one) may be
issued by the check multiple times; <strong class="program">clang-tidy</strong> will deduplicate
_identical_ warnings, but if the warnings are slightly different, all of them
will be shown to the user (and used for applying fixes, if any);</p></li>
<li><p>making replacements to a macro body/template definition may be fine for some
macro expansions/template instantiations, but easily break some other
expansions/instantiations.</p></li>
</ol>
</div>
<div class="section" id="running-clang-tidy-on-llvm">
<h3><a class="toc-backref" href="#id12">Running clang-tidy on LLVM</a><a class="headerlink" href="#running-clang-tidy-on-llvm" title="Permalink to this headline">¶</a></h3>
<p>To test a check it’s best to try it out on a larger code base. LLVM and Clang
are the natural targets as you already have the source code around. The most
convenient way to run <strong class="program">clang-tidy</strong> is with a compile command database;
CMake can automatically generate one, for a description of how to enable it see
<a class="reference external" href="http://clang.llvm.org/docs/HowToSetupToolingForLLVM.html">How To Setup Tooling For LLVM</a>. Once <code class="docutils literal notranslate"><span class="pre">compile_commands.json</span></code> is in place and
a working version of <strong class="program">clang-tidy</strong> is in <code class="docutils literal notranslate"><span class="pre">PATH</span></code> the entire code base
can be analyzed with <code class="docutils literal notranslate"><span class="pre">clang-tidy/tool/run-clang-tidy.py</span></code>. The script executes
<strong class="program">clang-tidy</strong> with the default set of checks on every translation unit
in the compile command database and displays the resulting warnings and errors.
The script provides multiple configuration flags.</p>
<ul class="simple">
<li><p>The default set of checks can be overridden using the <code class="docutils literal notranslate"><span class="pre">-checks</span></code> argument,
taking the identical format as <strong class="program">clang-tidy</strong> does. For example
<code class="docutils literal notranslate"><span class="pre">-checks=-*,modernize-use-override</span></code> will run the <code class="docutils literal notranslate"><span class="pre">modernize-use-override</span></code>
check only.</p></li>
<li><p>To restrict the files examined you can provide one or more regex arguments
that the file names are matched against.
<code class="docutils literal notranslate"><span class="pre">run-clang-tidy.py</span> <span class="pre">clang-tidy/.*Check\.cpp</span></code> will only analyze clang-tidy
checks. It may also be necessary to restrict the header files warnings are
displayed from using the <code class="docutils literal notranslate"><span class="pre">-header-filter</span></code> flag. It has the same behavior
as the corresponding <strong class="program">clang-tidy</strong> flag.</p></li>
<li><p>To apply suggested fixes <code class="docutils literal notranslate"><span class="pre">-fix</span></code> can be passed as an argument. This gathers
all changes in a temporary directory and applies them. Passing <code class="docutils literal notranslate"><span class="pre">-format</span></code>
will run clang-format over changed lines.</p></li>
</ul>
</div>
<div class="section" id="on-checks-profiling">
<h3><a class="toc-backref" href="#id13">On checks profiling</a><a class="headerlink" href="#on-checks-profiling" title="Permalink to this headline">¶</a></h3>
<p><strong class="program">clang-tidy</strong> can collect per-check profiling info, and output it
for each processed source file (translation unit).</p>
<p>To enable profiling info collection, use the <code class="docutils literal notranslate"><span class="pre">-enable-check-profile</span></code> argument.
The timings will be output to <code class="docutils literal notranslate"><span class="pre">stderr</span></code> as a table. Example output:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> clang-tidy -enable-check-profile -checks<span class="o">=</span>-*,readability-function-size source.cpp
<span class="go">===-------------------------------------------------------------------------===</span>
<span class="go">                          clang-tidy checks profiling</span>
<span class="go">===-------------------------------------------------------------------------===</span>
<span class="go">  Total Execution Time: 1.0282 seconds (1.0258 wall clock)</span>

<span class="go">   ---User Time---   --System Time--   --User+System--   ---Wall Time---  --- Name ---</span>
<span class="go">   0.9136 (100.0%)   0.1146 (100.0%)   1.0282 (100.0%)   1.0258 (100.0%)  readability-function-size</span>
<span class="go">   0.9136 (100.0%)   0.1146 (100.0%)   1.0282 (100.0%)   1.0258 (100.0%)  Total</span>
</pre></div>
</div>
<p>It can also store that data as JSON files for further processing. Example output:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> clang-tidy -enable-check-profile -store-check-profile<span class="o">=</span>.  -checks<span class="o">=</span>-*,readability-function-size source.cpp
<span class="gp">$</span> <span class="c1"># Note that there won&#39;t be timings table printed to the console.</span>
<span class="gp">$</span> ls /tmp/out/
<span class="go">20180516161318717446360-source.cpp.json</span>
<span class="gp">$</span> cat <span class="m">20180516161318717446360</span>-source.cpp.json
<span class="go">{</span>
<span class="go">&quot;file&quot;: &quot;/path/to/source.cpp&quot;,</span>
<span class="go">&quot;timestamp&quot;: &quot;2018-05-16 16:13:18.717446360&quot;,</span>
<span class="go">&quot;profile&quot;: {</span>
<span class="go">  &quot;time.clang-tidy.readability-function-size.wall&quot;: 1.0421266555786133e+00,</span>
<span class="go">  &quot;time.clang-tidy.readability-function-size.user&quot;: 9.2088400000005421e-01,</span>
<span class="go">  &quot;time.clang-tidy.readability-function-size.sys&quot;: 1.2418899999999974e-01</span>
<span class="go">}</span>
<span class="go">}</span>
</pre></div>
</div>
<p>There is only one argument that controls profile storage:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">-store-check-profile=&lt;prefix&gt;</span></code></p>
<p>By default reports are printed in tabulated format to stderr. When this option
is passed, these per-TU profiles are instead stored as JSON.
If the prefix is not an absolute path, it is considered to be relative to the
directory from where you have run <strong class="program">clang-tidy</strong>. All <code class="docutils literal notranslate"><span class="pre">.</span></code> and <code class="docutils literal notranslate"><span class="pre">..</span></code>
patterns in the path are collapsed, and symlinks are resolved.</p>
<p>Example:
Let’s suppose you have a source file named <code class="docutils literal notranslate"><span class="pre">example.cpp</span></code>, located in the
<code class="docutils literal notranslate"><span class="pre">/source</span></code> directory. Only the input filename is used, not the full path
to the source file. Additionally, it is prefixed with the current timestamp.</p>
<ul class="simple">
<li><p>If you specify <code class="docutils literal notranslate"><span class="pre">-store-check-profile=/tmp</span></code>, then the profile will be saved
to <code class="docutils literal notranslate"><span class="pre">/tmp/&lt;ISO8601-like</span> <span class="pre">timestamp&gt;-example.cpp.json</span></code></p></li>
<li><p>If you run <strong class="program">clang-tidy</strong> from within <code class="docutils literal notranslate"><span class="pre">/foo</span></code> directory, and specify
<code class="docutils literal notranslate"><span class="pre">-store-check-profile=.</span></code>, then the profile will still be saved to
<code class="docutils literal notranslate"><span class="pre">/foo/&lt;ISO8601-like</span> <span class="pre">timestamp&gt;-example.cpp.json</span></code></p></li>
</ul>
</li>
</ul>
</div>
</div>
</div>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        «&#160;&#160;<a href="../ReleaseNotes.html">Extra Clang Tools 7.0.0 Release Notes</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="checks/list.html">Clang-Tidy Checks</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2007-2021, The Clang Team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.2.
    </div>
  </body>
</html>